<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Cloud Learning Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <!-- Localization -->
  <script src="src/locales/en.js"></script>
  <script src="src/locales/zh.js"></script>
  <script src="src/locales/pt-BR.js"></script>
  <script src="src/locales/de.js"></script>
  <script src="src/i18n.js"></script>
  
  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Hide any dashboard components that might leak through */
    #dashboard-container {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- Shared navbar will be loaded here by JavaScript -->

  <!-- Main UI Container -->
  <div id="ui-container" class="absolute top-0 left-0 w-full h-full pointer-events-none">
    <!-- UI components will be dynamically loaded here -->
  </div>

  <!-- Game Canvas -->
  <div id="canvas-container"></div>

  <!-- Main Menu Modal (from original) -->
  <div id="main-menu-modal" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="relative bg-gray-900/90 p-12 rounded-2xl border border-blue-500/30 shadow-2xl max-w-md w-full text-center">
      <!-- Menu Mute Button -->
      <button id="menu-mute-btn" onclick="toggleMute()"
        class="absolute top-4 right-4 text-gray-400 hover:text-white transition p-2 rounded-full pulse-green">
        <span id="menu-mute-icon" class="text-xl">üîá</span>
      </button>

      <h1 data-i18n="title"
        class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 mb-2 tracking-tighter filter drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]">
        CLOUD LEARNING<br />SIMULATOR
      </h1>

      <div class="space-y-4">
        <button onclick="window.location.href='dashboard.html'" 
          class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-lg border border-cyan-400/50">
          üè† Dashboard
        </button>

        <button id="resume-btn" onclick="resumeGame()" data-i18n="resume_game"
          class="hidden w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-lg border border-blue-400/50">
          Resume Game
        </button>

        <button onclick="startGame()" data-i18n="start_survival"
          class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-lg border border-green-400/50">
          Start Survival
        </button>

        <button onclick="startSandbox()" data-i18n="sandbox_mode"
          class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-lg border border-purple-400/50">
          Sandbox Mode
        </button>

        <button onclick="loadGameState()" id="load-btn" data-i18n="continue_game"
          class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-lg border border-cyan-400/50">
          Continue Game
        </button>

        <button onclick="showFAQ()" data-i18n="manual_faq"
          class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold py-3 px-8 rounded-lg border border-gray-600 transition hover:text-white font-mono uppercase">
          Manual / FAQ
        </button>
      </div>

      <div class="mt-8 text-xs text-gray-500 font-mono"></div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="glass-panel p-8 rounded-2xl text-center max-w-md border border-gray-600">
      <h2 id="modal-title" data-i18n="system_failure" class="text-4xl font-bold mb-4 text-white font-mono tracking-tighter">
        SYSTEM FAILURE
      </h2>
      <div class="h-px w-full bg-gray-700 mb-6"></div>
      <p id="modal-desc" data-i18n="infra_collapsed" class="text-gray-300 mb-8 text-sm leading-relaxed">
        Infrastructure collapsed.
      </p>
      <div class="flex justify-center gap-4">
        <button onclick="retryWithSameArchitecture()" data-i18n="retry_same"
          class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-sm">
          Retry Same Setup
        </button>
        <button onclick="restartGame()" data-i18n="start_fresh"
          class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:scale-105 font-mono uppercase text-sm">
          Start Fresh
        </button>
      </div>
    </div>
  </div>

  <!-- FAQ Modal -->
  <div id="faq-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-50 hidden">
    <div class="glass-panel p-8 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-700">
      <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
        <h2 data-i18n="operator_manual" class="text-2xl font-bold text-white">OPERATOR MANUAL</h2>
        <button onclick="closeFAQ()" class="text-gray-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="text-center">
        <p class="text-gray-400">FAQ content would be loaded here...</p>
        <button onclick="closeFAQ()" data-i18n="close_manual"
          class="mt-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-8 rounded-lg transition">
          Close Manual
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loading-screen" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="text-4xl font-bold text-cyan-400 mb-4">Cloud Learning Simulator</div>
      <div class="text-lg text-gray-400 mb-8">Initializing modular architecture...</div>
      <div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden">
        <div id="loading-progress" class="h-full bg-cyan-500 transition-all duration-300" style="width: 0%"></div>
      </div>
      <div id="loading-status" class="text-sm text-gray-500 mt-4">Loading core systems...</div>
    </div>
  </div>

  <!-- Core Scripts -->
  <script src="src/config.js"></script>
  <script src="src/state.js"></script>
  <script src="src/entities/Request.js"></script>
  <script src="src/entities/Service.js"></script>
  <script src="src/services/SoundService.js"></script>
  <script src="src/tutorial.js"></script>
  
  <!-- Game Logic (will be modularized) -->
  <script src="game.js"></script>

  <!-- Application Bootstrap -->
  <script type="module">
    import { ApplicationController } from './src/core/ApplicationController.js';

    // Global application instance
    window.app = new ApplicationController();

    // Loading progress tracking
    let loadingProgress = 0;
    const progressBar = document.getElementById('loading-progress');
    const statusText = document.getElementById('loading-status');

    function updateProgress(progress, status) {
      loadingProgress = Math.min(100, progress);
      progressBar.style.width = `${loadingProgress}%`;
      statusText.textContent = status;
    }

    // Initialize application
    async function initializeApp() {
      try {
        updateProgress(10, 'Loading core systems...');
        
        // Load shared navbar first
        await loadSharedNavbar();
        updateProgress(20, 'Shared navbar loaded');
        
        // Initialize the application controller
        await window.app.initialize();
        updateProgress(30, 'Core systems loaded');

        updateProgress(50, 'Loading UI components...');
        
        // Load UI components (but not dashboard)
        const { StatsPanel } = await import('./src/ui/components/StatsPanel.js');
        const { ToolbarPanel } = await import('./src/ui/components/ToolbarPanel.js');
        
        updateProgress(70, 'Initializing UI components...');
        
        // Initialize UI components (but not dashboard)
        await window.app.loadModule('statsPanel', StatsPanel);
        await window.app.loadModule('toolbarPanel', ToolbarPanel);
        
        updateProgress(90, 'Finalizing setup...');

        // Apply translations
        if (window.i18n) {
          window.i18n.applyTranslations();
        }

        // Ensure legacy game integration
        if (window.STATE) {
          console.log('Legacy game state detected, integrating...');
        }

        updateProgress(100, 'Ready!');

        // Hide loading screen
        setTimeout(() => {
          document.getElementById('loading-screen').classList.add('hidden');
          
          // Show shared navbar immediately
          if (window.sharedNavbar) {
            window.sharedNavbar.show();
          }
          
          // Show main menu after modular system is ready
          if (typeof window.showMainMenu === 'function') {
            window.showMainMenu();
          }
          
          // Emit app ready event
          window.app.getModule('eventSystem').emit('app:ready');
          
          console.log('Cloud Learning Simulator: Modular architecture initialized successfully');
        }, 500);

      } catch (error) {
        console.error('Failed to initialize application:', error);
        statusText.textContent = 'Initialization failed. Please refresh the page.';
        statusText.className = 'text-sm text-red-500 mt-4';
      }
    }

    // Load shared navbar
    async function loadSharedNavbar() {
      try {
        // Load the shared navbar script
        const script = document.createElement('script');
        script.src = 'shared/navbar.js';
        document.head.appendChild(script);
        
        // Wait for script to load
        await new Promise((resolve) => {
          script.onload = resolve;
        });
        
        // Wait a bit for the navbar to initialize
        await new Promise(resolve => setTimeout(resolve, 100));
        
        console.log('Shared navbar loaded for game');
      } catch (error) {
        console.error('Failed to load shared navbar:', error);
      }
    }

    // Global function to show dashboard
    window.showDashboard = function() {
      const router = window.app?.getModule('router');
      const navigation = window.app?.getModule('navigation');
      
      if (router && navigation) {
        // Hide main menu
        const mainMenu = document.getElementById('main-menu-modal');
        if (mainMenu) {
          mainMenu.classList.add('hidden');
        }
        
        // Show navigation
        navigation.show();
        
        // Navigate to dashboard
        router.navigateTo('home');
        console.log('Navigating to dashboard...');
      } else {
        console.error('Router or Navigation not available');
        alert('Dashboard not available - please refresh the page');
      }
    };

    // Global function to show main menu (for returning from game)
    window.showMainMenu = function() {
      const mainMenu = document.getElementById('main-menu-modal');
      
      if (mainMenu) {
        mainMenu.classList.remove('hidden');
      }
      
      // Show shared navigation bar
      if (window.sharedNavbar) {
        window.sharedNavbar.show();
      }
    };

    // Global function to hide main menu and navbar (when starting game)
    window.hideMainMenu = function() {
      const mainMenu = document.getElementById('main-menu-modal');
      
      if (mainMenu) {
        mainMenu.classList.add('hidden');
      }
      
      // Hide shared navigation bar during gameplay
      if (window.sharedNavbar) {
        window.sharedNavbar.hide();
      }
    };

    // Mobile menu toggle (removed - now handled by shared navbar)

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }

    // Global error handling
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      if (window.app && window.app.getModule('eventSystem')) {
        window.app.getModule('eventSystem').emit('app:error', { error: e.error });
      }
    });

    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled promise rejection:', e.reason);
      if (window.app && window.app.getModule('eventSystem')) {
        window.app.getModule('eventSystem').emit('app:error', { error: e.reason });
      }
    });
  </script>
</body>

</html>